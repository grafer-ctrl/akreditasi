<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Akreditasi Radiologi (Final)</title>
    
    <!-- Library Tampilan (Bootstrap & FontAwesome) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* --- CSS STYLE (Tampilan) --- */
        :root { --primary-color: #4e73df; --bg-color: #f8f9fc; --success-color: #1cc88a; --warning-color: #f6c23e; --danger-color: #e74a3b; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: #5a5c69; padding-bottom: 80px; }
        
        /* Header */
        .app-header { background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); color: white; padding: 30px 0 60px; margin-bottom: -40px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Tabel & Card */
        .main-card { background: white; border-radius: 20px; border: none; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); overflow: hidden; }
        .table thead th { background-color: #eaecf4; color: #4e73df; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; padding: 15px; border: none; }
        .table tbody td { vertical-align: middle; padding: 15px; border-bottom: 1px solid #e3e6f0; }
        
        /* Badges */
        .badge-code { background-color: #eef2ff; color: #4e73df; font-weight: 700; padding: 6px 10px; border-radius: 8px; font-size: 0.85rem; }
        .badge-ep { background-color: #f8f9fc; border: 1px solid #d1d3e2; color: #858796; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.75rem; flex-shrink: 0; }
        .doc-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 15px; margin-right: 3px; display: inline-block; font-weight: 600; margin-bottom: 3px;}
        .tag-regulasi { background-color: #d1e7dd; color: #0f5132; }
        .tag-dokumen { background-color: #f8d7da; color: #842029; }
        
        /* Dropdown Status */
        .form-select-custom { border-radius: 50px; font-weight: 600; font-size: 0.8rem; text-align: center; text-align-last: center; border: none; color: white; cursor: pointer; padding: 8px 25px 8px 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bg-sudah { background-color: var(--success-color) !important; }
        .bg-proses { background-color: var(--warning-color) !important; color: #333 !important; }
        .bg-belum { background-color: var(--danger-color) !important; }
        
        /* Tombol Upload */
        .btn-upload { border: 2px dashed #4e73df; color: #4e73df; background-color: #f8f9fc; padding: 8px 12px; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s; position: relative; }
        .btn-upload:hover { background-color: #eef2ff; }
        .btn-upload.loading { pointer-events: none; opacity: 0.6; }
        
        /* File List */
        .file-list { margin-top: 10px; max-height: 150px; overflow-y: auto; }
        .file-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e3e6f0; padding: 5px 10px; margin-bottom: 5px; border-radius: 6px; font-size: 0.75rem; }
        .file-link { text-decoration: none; color: #333; display: flex; align-items: center; flex-grow: 1; overflow: hidden; cursor: pointer; }
        .file-link:hover { color: var(--primary-color); }
        .file-icon { margin-right: 8px; font-size: 1.1em; }
        .fa-file-pdf { color: #e74a3b; }
        .fa-file-word { color: #4e73df; }
        .btn-delete-file { color: #ccc; cursor: pointer; padding: 0 5px; margin-left: 10px; }
        .btn-delete-file:hover { color: #e74a3b; }

        @media (max-width: 768px) {
            .table thead { display: none; }
            .table, .table tbody, .table tr, .table td { display: block; width: 100%; }
            .table tr { margin-bottom: 20px; background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #f1f1f1; padding: 15px; }
            .table td { padding: 8px 0; border: none; }
            .mobile-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="container">
            <h2 class="fw-bold mb-0"><i class="fas fa-cloud me-2"></i>Akreditasi Radiologi</h2>
            <p class="mb-0 opacity-75 small">
                Status Koneksi: <span id="statusBadge" class="badge bg-secondary">Menghubungkan...</span>
            </p>
        </div>
    </header>

    <div class="container" style="margin-top: -30px;">
        <!-- Loading Screen -->
        <div id="loadingScreen" class="text-center py-5 bg-white rounded shadow-sm mb-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Mengambil data dari Firebase...</p>
        </div>

        <!-- Konten Utama -->
        <div id="mainContent" class="d-none">
            <!-- Progress Bar -->
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 15px; border-left: 5px solid #1cc88a !important;">
                <div class="card-body d-flex align-items-center justify-content-between py-3">
                    <div>
                        <div class="text-xs fw-bold text-success text-uppercase mb-1">Total Capaian</div>
                        <div class="h5 mb-0 fw-bold text-gray-800" id="progressText">0%</div>
                    </div>
                    <div class="w-50 mx-3">
                        <div class="progress" style="height: 10px; border-radius: 5px;">
                            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabel Data -->
            <div class="main-card mb-5">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th width="10%">Kode</th>
                                <th width="40%">Elemen Penilaian</th>
                                <th width="12%">Bukti</th>
                                <th width="15%">Status</th>
                                <th width="23%">File Cloud</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK (COMPAT VERSION) - Wajib untuk Web HTML -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // ===============================================
        // 1. CONFIGURATION (DATA ANDA)
        // ===============================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_uk9gXZb74jpoPl7-uJ8wj2FvWB-ncPE",
            authDomain: "akreditasi-radiologi.firebaseapp.com",
            projectId: "akreditasi-radiologi",
            
            // PENTING: Saya ubah ke .appspot.com agar lebih stabil
            storageBucket: "akreditasi-radiologi.app.com", 
            
            messagingSenderId: "279886019434",
            appId: "1:279886019434:web:e0251078598c49da2c4313"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error("Firebase Init Error:", e); }

        const db = firebase.firestore();
        const storage = firebase.storage();
        
        const COLLECTION_NAME = "checklists";
        const DOC_ID = "radiologi_data_utama";

        // ===============================================
        // 2. DATA DEFAULT
        // ===============================================
        const defaultData = [
            { code: "PP 4", ep: "1", text: "RS menetapkan regulasi pelayanan radiologi klinik", type: ["Regulasi", "Dokumen"], status: "belum", files: [] },
            { code: "PP 4", ep: "2", text: "Pelayanan radiologi 24 jam, 7 hari seminggu", type: ["Regulasi", "Dokumen"], status: "belum", files: [] },
            { code: "PP 4.1", ep: "1", text: "Direktur menetapkan PJ radiologi klinik yang kompeten.", type: ["Regulasi", "Dokumen"], status: "belum", files: [] },
            { code: "PP 4.1", ep: "2", text: "Bukti pengawasan pelayanan oleh PJ radiologi.", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.2", ep: "1", text: "Staf interpretasi memenuhi persyaratan kredensial", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.2", ep: "2", text: "Staf pelaksana memenuhi persyaratan kredensial.", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.3", ep: "1", text: "Kerangka waktu penyelesaian pemeriksaan radiologi.", type: ["Regulasi"], status: "belum", files: [] },
            { code: "PP 4.3", ep: "2", text: "Evaluasi waktu penyelesaian pemeriksaan.", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.3", ep: "3", text: "Evaluasi waktu penyelesaian pemeriksaan cito.", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.3", ep: "4", text: "Bukti evaluasi pelayanan radiologi rujukan.", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.4", ep: "1", text: "Pengelolaan logistik film, reagens, dan bahan lainnya.", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.4", ep: "2", text: "Film x-ray disimpan & dilabel sesuai pedoman.", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.5", ep: "1", text: "Bukti pelaksanaan Pemantapan Mutu Internal (PMI).", type: ["Dokumen"], status: "belum", files: [] },
            { code: "PP 4.5", ep: "2", text: "Bukti pelaksanaan Pemantapan Mutu Eksternal (PME).", type: ["Dokumen"], status: "belum", files: [] }
        ];

        let appData = [];

        // ===============================================
        // 3. LOGIC (Init, Render, Upload)
        // ===============================================

        function initApp() {
            // Ambil data realtime dari Firestore
            db.collection(COLLECTION_NAME).doc(DOC_ID).onSnapshot((doc) => {
                const badge = document.getElementById('statusBadge');
                badge.innerText = "Terhubung (Online)";
                badge.className = "badge bg-success";

                if (doc.exists) {
                    appData = doc.data().items;
                } else {
                    appData = JSON.parse(JSON.stringify(defaultData));
                    db.collection(COLLECTION_NAME).doc(DOC_ID).set({ items: appData });
                }
                
                renderTable();
                document.getElementById('loadingScreen').classList.add('d-none');
                document.getElementById('mainContent').classList.remove('d-none');
            }, (error) => {
                console.error("Database Error:", error);
                const badge = document.getElementById('statusBadge');
                badge.innerText = "Gagal Koneksi";
                badge.className = "badge bg-danger";
                alert("Gagal mengambil data database! Pastikan 'Rules' Firestore sudah benar.");
            });
        }

        function saveToCloud() {
            db.collection(COLLECTION_NAME).doc(DOC_ID).update({ items: appData })
            .catch(err => console.error("Save Error:", err));
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            let html = '';

            appData.forEach((item, index) => {
                let badges = item.type.map(t => `<span class="doc-tag ${t === 'Regulasi' ? 'tag-regulasi' : 'tag-dokumen'}">${t}</span>`).join('');
                let statusClass = item.status === 'sudah' ? 'bg-sudah' : (item.status === 'proses' ? 'bg-proses' : 'bg-belum');

                html += `
                    <tr>
                        <td class="code-col">
                            <div class="d-flex align-items-center justify-content-between d-md-block mobile-header">
                                <span class="badge-code">${item.code}</span>
                                <span class="d-md-none badge-ep">EP ${item.ep}</span>
                            </div>
                        </td>
                        <td class="desc-col">
                            <div class="d-flex align-items-start">
                                <span class="badge-ep me-3 d-none d-md-flex">${item.ep}</span>
                                <div>${item.text}</div>
                            </div>
                        </td>
                        <td class="type-col">${badges}</td>
                        <td class="action-col">
                            <select class="form-select form-select-custom ${statusClass}" onchange="updateStatus(this, ${index})">
                                <option value="sudah" ${item.status === 'sudah' ? 'selected' : ''}>Sudah Ada</option>
                                <option value="proses" ${item.status === 'proses' ? 'selected' : ''}>Proses</option>
                                <option value="belum" ${item.status === 'belum' ? 'selected' : ''}>Belum Ada</option>
                            </select>
                        </td>
                        <td class="upload-col">
                            <input type="file" id="fileInput-${index}" class="d-none" multiple accept=".pdf,.doc,.docx" onchange="uploadFiles(this, ${index})">
                            <label for="fileInput-${index}" class="btn-upload text-center" id="btnLabel-${index}">
                                <i class="fas fa-cloud-upload-alt me-1"></i> Upload
                            </label>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted" style="font-size: 0.65rem;" id="count-${index}">${item.files.length} File</small>
                            </div>
                            <div class="file-list" id="fileList-${index}"></div>
                        </td>
                    </tr>`;
            });

            tbody.innerHTML = html;
            appData.forEach((_, idx) => renderFileList(idx));
            calculateProgress();
        }

        function updateStatus(element, index) {
            appData[index].status = element.value;
            saveToCloud();
        }

        async function uploadFiles(input, index) {
            const files = input.files;
            if (files.length === 0) return;

            const labelBtn = document.getElementById(`btnLabel-${index}`);
            labelBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span> Uploading...`;
            labelBtn.classList.add('loading');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const uniqueName = Date.now() + '_' + file.name;
                const fileRef = storage.ref().child('dokumen_akreditasi/' + uniqueName);

                try {
                    const snapshot = await fileRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    appData[index].files.push({ 
                        name: file.name, 
                        url: downloadURL, 
                        path: 'dokumen_akreditasi/' + uniqueName 
                    });
                } catch (err) {
                    console.error("Upload Error:", err);
                    alert("Upload GAGAL! Mohon cek tab 'Rules' di menu Storage Firebase Console Anda. Pastikan sudah allow read/write.");
                }
            }
            saveToCloud();
            input.value = '';
            renderFileList(index);
            labelBtn.innerHTML = `<i class="fas fa-cloud-upload-alt me-1"></i> Upload`;
            labelBtn.classList.remove('loading');
        }

        function renderFileList(index) {
            const container = document.getElementById(`fileList-${index}`);
            const countLabel = document.getElementById(`count-${index}`);
            const files = appData[index].files;
            
            countLabel.innerText = `${files.length} File`;
            container.innerHTML = '';

            files.forEach((fileObj, fileIdx) => {
                const ext = fileObj.name.split('.').pop().toLowerCase();
                let iconClass = (ext === 'doc' || ext === 'docx') ? 'fa-file-word' : 'fa-file-pdf';

                const div = document.createElement('div');
                div.className = 'file-item';
                div.innerHTML = `
                    <a href="${fileObj.url}" target="_blank" class="file-link" title="${fileObj.name}">
                        <i class="fas ${iconClass} file-icon"></i>
                        <span class="text-truncate" style="max-width: 130px;">${fileObj.name}</span>
                    </a>
                    <i class="fas fa-trash-alt btn-delete-file" onclick="deleteFile(${index}, ${fileIdx})" title="Hapus"></i>`;
                container.appendChild(div);
            });
        }

        function deleteFile(rowIndex, fileIdx) {
            if(!confirm("Hapus file ini permanen?")) return;
            const fileObj = appData[rowIndex].files[fileIdx];
            
            storage.ref().child(fileObj.path).delete().then(() => {
                removeFromDb(rowIndex, fileIdx);
            }).catch(err => {
                console.warn("File not found on storage, removing from DB.");
                removeFromDb(rowIndex, fileIdx);
            });
        }

        function removeFromDb(rowIndex, fileIdx) {
            appData[rowIndex].files.splice(fileIdx, 1);
            saveToCloud();
            renderFileList(rowIndex);
        }

        function calculateProgress() {
            const total = appData.length;
            const completed = appData.filter(i => i.status === 'sudah').length;
            const percentage = Math.round((completed / total) * 100);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').innerText = percentage + '%';
        }

        // Start Application
        window.onload = initApp;

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
